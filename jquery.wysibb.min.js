(function(c){c.fn.wysibb=function(z,A){function n(i,n){return i.replace(/\{([\w\.]*)\}/g,function(i,y){var u=y.split("."),o=n[u.shift()];c.each(u,function(){o=o[this]});return null===o||void 0===o?"":o})}function q(c){i.debug&&"undefined"!=typeof console&&console.log(c)}var i,D;i={debug:!1,onlyBBmode:!1,bbmode:!1,watchTxtArea:!0,smileAutoDetect:!0,themeName:"default",bbset:"default",themePrefix:"http://www.wysibb.com/static/theme/",validTags:"a b i s u div img ul li br p q strike blockquote table tr td".split(" "),
textTags:"span,font",buttons:"bold,italic,underline,strike,sup,sub,|,justifyleft,justifycenter,justifyright,|,link,img,|,bullist,numlist,quote,offtopic,code,spoiler",allButtons:{bold:{title:"\u0416\u0438\u0440\u043d\u044b\u0439",buttonHTML:'<span class="ve-tlb-bold"></span>',command:'new NativeCommand("Bold")',bbName:"b",bbOpen:"[b]",bbClose:"[/b]",htmlToBB:{b:"[b]%$(this).html()%[/b]",strong:"[b]%$(this).html()%[/b]"},bbToHTML:{"[b](.*?)[/b]":"<b>$1</b>"}},italic:{title:"\u041a\u0443\u0440\u0441\u0438\u0432",
buttonHTML:'<span class="ve-tlb-italic"></span>',command:'new NativeCommand("Italic")',bbName:"i",bbOpen:"[i]",bbClose:"[/i]",htmlToBB:{i:"[i]%$(this).html()%[/i]",em:"[i]%$(this).html()%[/i]"},bbToHTML:{"[i](.*?)[/i]":"<i>$1</i>"}},underline:{title:"\u041f\u043e\u0434\u0447\u0435\u0440\u043a\u043d\u0443\u0442\u044b\u0439",buttonHTML:'<span class="ve-tlb-underline"></span>',command:'new NativeCommand("Underline")',bbName:"u",bbOpen:"[u]",bbClose:"[/u]",htmlToBB:{u:"[u]%$(this).html()%[/u]"},bbToHTML:{"[u](.*?)[/u]":"<u>$1</u>"}},
strike:{title:"\u0417\u0430\u0447\u0435\u0440\u043a\u043d\u0443\u0442\u044b\u0439",buttonHTML:'<span class="ve-tlb-strike"></span>',command:'new NativeCommand("StrikeThrough")',bbName:"s",bbOpen:"[s]",bbClose:"[/s]",htmlToBB:{strike:"[s]%$(this).html()%[/s]"},bbToHTML:{"[s](.*?)[/s]":"<s>$1</s>"}},link:{title:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u0441\u0441\u044b\u043b\u043a\u0443",buttonHTML:'<span class="ve-tlb-link"></span>',command:"new linkCommand()",bbName:"url",bbOpen:"[url={href}]{href}",
skipSelectRange:!0,bbClose:"[/url]",htmlToBB:{a:'[url=%$(this).attr("href")%]%$(this).html()%[/url]'},bbToHTML:{"[url=(.*?)](.*?)[/url]":'<a href="$1">$2</a>'}},img:{title:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435",buttonHTML:'<span class="ve-tlb-img"></span>',command:"new imgCommand()",bbName:"img",bbOpen:"[img]{src}",bbClose:"[/img]",skipSelectRange:!0,htmlToBB:{img:'[img]%$(this).attr("src")%[/img]'},bbToHTML:{"[img](.*?)[/img]":'<img src="$1" />'}},
bullist:{title:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u0441\u043f\u0438\u0441\u043e\u043a",buttonHTML:'<span class="ve-tlb-list"></span>',command:'new NativeCommand("InsertUnorderedList")',bbName:"list",bbOpen:"[list]\n[*]",bbClose:"\n[/list]",htmlToBB:{ul:"[list]%$(this).html()%[/list]",li:"[*]%$(this).html()%"},bbToHTML:{"[*](.*?)(?=[)":"<li>$1</li>","[list](.*?)[/list]":"<ul>$1</ul>"}},numlist:{title:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u043d\u0443\u043c\u0435\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0439 \u0441\u043f\u0438\u0441\u043e\u043a",
buttonHTML:'<span class="ve-tlb-numlist"></span>',command:'new NativeCommand("InsertOrderedList")',bbName:"list=1",bbOpen:"[list=1]\n[*]",bbClose:"\n[/list]",htmlToBB:{ol:"[list=1]%$(this).html()%[/list]",li:"[*]%$(this).html()%"},bbToHTML:{"[*](.*?)(?=[)":"<li>$1</li>","[list=1](.*?)[/list]":"<ol>$1</ol>"}},justifyleft:{title:"\u0422\u0435\u043a\u0441\u0442 \u043f\u043e \u043b\u0435\u0432\u043e\u043c\u0443 \u043a\u0440\u0430\u044e",buttonHTML:'<span class="ve-tlb-textleft"></span>',command:'new justifyCommand("justifyleft")',
htmlOpen:'<div class="wbb-left">',htmlClose:"</div>",bbName:"left",bbOpen:"[left]",bbClose:"[/left]",htmlToBB:{"div.wbb-left":"[left]%$(this).html()%[/left]"},rootNode:"div.wbb-left",contentSelector:"$(rootNode).html()"},justifycenter:{title:"\u0422\u0435\u043a\u0441\u0442 \u043f\u043e \u0446\u0435\u043d\u0442\u0440\u0443",buttonHTML:'<span class="ve-tlb-textcenter"></span>',command:'new justifyCommand("justifycenter")',htmlOpen:'<div class="wbb-center" style="text-align:center">',htmlClose:"</div>",
bbName:"center",bbOpen:"[center]",bbClose:"[/center]",htmlToBB:{"div.wbb-center":"[center]%$(this).html()%[/center]"},rootNode:"div.wbb-center",contentSelector:"$(rootNode).html()"},justifyright:{title:"\u0422\u0435\u043a\u0441\u0442 \u043f\u0440\u0430\u0432\u043e\u043c\u0443 \u043a\u0440\u0430\u044e",buttonHTML:'<span class="ve-tlb-textright"></span>',command:'new justifyCommand("justifyright")',htmlOpen:'<div class="wbb-right" style="text-align:right">',htmlClose:"</div>",bbName:"right",bbOpen:"[right]",
bbClose:"[/right]",htmlToBB:{"div.wbb-right":"[right]%$(this).html()%[/right]"},rootNode:"div.wbb-right",contentSelector:"$(rootNode).html()"},offtopic:{title:"\u041e\u0444\u0444\u0442\u043e\u043f",buttonHTML:'<span class="ve-tlb-offtopic"></span>',command:'new CustomCommand("offtopic")',htmlOpen:'<span class="offtop" style="font-size:9px;color:gray;">',htmlClose:"</span>",bbName:"offtop",bbOpen:"[offtop]",bbClose:"[/offtop]",htmlToBB:{"span.offtop":"[offtop]%$(this).html()%[/offtop]"},rootNode:"span.offtop",
contentSelector:"$(rootNode).html()"},code:{title:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u043a\u043e\u0434",buttonHTML:'<span class="ve-tlb-code"></span>',command:'new CustomCommand("code")',htmlOpen:'<div class="code"><div class="codetop">\u041a\u043e\u0434</div><div class="codemain">',htmlClose:"</div></div>",bbName:"code",bbOpen:"[code]",bbClose:"[/code]",htmlToBB:{"div.codetop":'[code]%$(this).skipWBB().next("div.codemain").skipWBB().html()%[/code]'},rootNode:"div.code",contentSelector:'$(rootNode).find("div.codemain").html()'},
spoiler:{title:"\u0421\u0432\u043e\u0440\u0430\u0447\u0438\u0432\u0430\u0435\u043c\u044b\u0439 \u0442\u0435\u043a\u0441\u0442",buttonHTML:'<span class="ve-tlb-spoiler"></span>',command:'new CustomCommand("spoiler")',htmlOpen:'<div class="spoiler"><div class="hidetop">\u0421\u043f\u043e\u0439\u043b\u0435\u0440 (+/-)</div><div class="hidemain">',htmlClose:"</div></div>",bbName:"spoiler",bbOpen:"[spoiler]",bbClose:"[/spoiler]",htmlToBB:{"div.spoiler":'[spoiler]%$(this).children("div.hidetop").skipWBB().next("div.hidemain").html()%[/spoiler]'},
rootNode:"div.spoiler",contentSelector:'$(rootNode).find("div.hidemain").html()',removeFormatOnDeSelect:!0},sub:{title:"\u041f\u043e\u0434\u0441\u0442\u0440\u043e\u0447\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442",buttonHTML:'<span class="ve-tlb-sub"></span>',command:'new NativeCommand("subscript")',bbName:"sub",bbOpen:"[sub]",bbClose:"[/sub]",htmlToBB:{sub:"[sub]%$(this).html()%[/sub]"},bbToHTML:{"[sub](.*?)[/sub]":"<sub>$1</sub>"}},sup:{title:"\u041d\u0430\u0434\u0441\u0442\u0440\u043e\u0447\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442",
buttonHTML:'<span class="ve-tlb-sup"></span>',command:'new NativeCommand("superscript")',bbName:"sup",bbOpen:"[sup]",bbClose:"[/sup]",htmlToBB:{sup:"[sup]%$(this).html()%[/sup]"},bbToHTML:{"[sup](.*?)[/sup]":"<sup>$1</sup>"}},quote:{title:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u0446\u0438\u0442\u0430\u0442\u0443",buttonHTML:'<span class="ve-tlb-quote"></span>',command:"new quoteCommand()",bbName:"quote",bbOpen:"[quote]",bbClose:"[/quote]",htmlToBB:{"div.blockquote":"[quote]%$(this).html()%[/quote]"},
bbToHTML:{"[quote](.*?)[/quote]":'<div class="quote">$1</div>'},insertHTML:'<div class="blockquote">{SELTEXT}</div>',rootNode:"div.blockquote"},wbbConvertation:{htmlToBB:{td:"[td]%$(this).html()%[/td]",tr:"[tr]%$(this).html()%[/tr]",table:"[table]%$(this).html()%[/table]"},bbToHTML:{"[table](.*?)[/table]":"<table>$1</table>","[tr](.*?)[/tr]":"<tr>$1</tr>","[td](.*?)[/td]":"<td>$1</td>","\n":"<br/>"}}},smileList:[{title:"\u0423\u043b\u044b\u0431\u043a\u0430",img:'<img src="{themePrefix}{themeName}/img/smiles/sm1.png" class="sm">',
bbcode:":)"},{title:"\u041e\u0433\u043e\u0440\u0447\u0435\u043d\u0438\u0435",img:'<img src="{themePrefix}{themeName}/img/smiles/sm8.png" class="sm">',bbcode:":("},{title:"\u0421\u043c\u0435\u0445",img:'<img src="{themePrefix}{themeName}/img/smiles/sm2.png" class="sm">',bbcode:":D"},{title:"\u041f\u043e\u0434\u043c\u0438\u0433\u0438\u0432\u0430\u043d\u0438\u0435",img:'<img src="{themePrefix}{themeName}/img/smiles/sm3.png" class="sm">',bbcode:";)"},{title:"\u0421\u043f\u0430\u0441\u0438\u0431\u043e, \u043a\u043b\u0430\u0441\u0441",
img:'<img src="{themePrefix}{themeName}/img/smiles/sm4.png" class="sm">',bbcode:":up:"},{title:"\u0420\u0443\u0433\u0430\u044e",img:'<img src="{themePrefix}{themeName}/img/smiles/sm5.png" class="sm">',bbcode:":down:"},{title:"\u0428\u043e\u043a",img:'<img src="{themePrefix}{themeName}/img/smiles/sm6.png" class="sm">',bbcode:":shock:"},{title:"\u0417\u043b\u043e\u0439",img:'<img src="{themePrefix}{themeName}/img/smiles/sm7.png" class="sm">',bbcode:":angry:"},{title:"\u0422\u043e\u0448\u043d\u0438\u0442",
img:'<img src="{themePrefix}{themeName}/img/smiles/sm9.png" class="sm">',bbcode:":sick:"}]};c.extend(i,z,A);i.themePrefix||c("script").each(function(n,t){var q=c(t).get(0).src.match(/(.*)jquery\.wysibb(\.min)?\.js$/);null!==q&&(i.themePrefix=q[1])});D=/android.+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent||
navigator.vendor||window.opera)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|e\-|e\/|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(di|rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|xda(\-|2|g)|yas\-|your|zeto|zte\-/i.test((navigator.userAgent||
navigator.vendor||window.opera).substr(0,4))?!0:!1;-1!=navigator.userAgent.toLowerCase().indexOf("msie 6")&&navigator.userAgent.toLowerCase().indexOf("msie 7");navigator.userAgent.toLowerCase().indexOf("msie 7");return this.each(function(){function y(b,a,d){this.updateUI=function(){b.queryState(d)?c(a).addClass("on"):c(a).removeClass("on")};c(a).attr("unselectable","on");c(a).find("*").attr("unselectable","on");c(a).bind("mousedown",function(a){a.preventDefault&&a.preventDefault()});c(a).click(function(){b.execute(d);
t()})}function t(){c(C).each(function(b,a){a.updateUI()})}function z(){this.execute=function(b){if(k){j.focus();var a=m.getTextWithInfo(),c=b.bbOpen?b.bbOpen:"",g=b.bbClose?b.bbClose:"",h=b.bbcode?b.bbcode:"";!0===b.skipSelectRange&&(a.text="");var f="",f=""!=h?h:n(c+a.text+g,null);j.value=j.value.substr(0,a.start)+f+j.value.substr(a.end,j.value.length-a.end);"url"!=b.bbName&&("img"!=b.bbName&&(!a||0==a.length))&&m.setRange(a.start+f.length-g.length)}else l.focus(),m.overrideWithNode(n(b.img,i))};
this.queryState=function(){return!1}}function B(b){var a="";E(l);var b=c(b).clone(),d;for(d in i.smileList){var g=i.smileList[d],h=g.bbcode,f=c(g&&g.img?g.img:"");b.find("img").each(function(){c(this).attr("src")==f.attr("src")&&c(this).replaceWith(h)})}for(d=0;d<w.length;d++){var g=i.allButtons[w[d]].htmlToBB,j;for(j in g){var k=g[j];b.find(j).each(function(a,b){var d=k,d=d.replace(/\%(.*?)\%/g,function(a){a=a.substr(1,a.length-2);a=a.replace("this","el");try{return eval(a)}catch(d){return c(b).html()}});
c(b).replaceWith("<span>"+d+"</span>")})}}b.find("*[mustremoved='1']").remove();b.contents().each(function(){if(3===this.nodeType){var b=c(this).text();a+=b}else if(c(this)[0].tagName){if("br"==c(this)[0].tagName.toLowerCase())return a+="\n",!0;a+=B(this)}});return a}function u(b){for(var a=0;a<i.smileList.length;a++){var d=i.smileList[a],g=d.bbcode;if(d&&d.img)var g=g.replace(/([^a-z0-9])/gi,"\\$1"),h=RegExp(g,"mg"),b=b.replace(h,d.img)}for(a=0;a<w.length;a++){d=i.allButtons[w[a]];g=d.bbToHTML;g||
(g={},g[d.bbOpen+"(.*?)"+d.bbClose]=d.htmlOpen+"$1"+d.htmlClose);for(var f in g)d=g[f],f=f.replace(/\*\]/g,"\\*]"),f=f.replace(/\[/g,"\\["),f=f.replace(/\]/g,"\\]"),f=f.replace(/\\\[\\\[/g,"["),f=f.replace(/\\\]\\\]/g,"]"),h=RegExp(f,"mi"),b=F(b,h,d)}f=c("<div>"+b+"</div>");f.find("ul > br,table > br, tr > br").each(function(a,b){c(b).remove()});return f.html()}function o(b){c(b).children().each(function(){var a=c(this)[0].tagName.toLowerCase();if("p"==a||"div"==a){a=!1;if(1>=c(this).children().size()){var b=
c(this).text().replace(/\s+/g,""),b=b.replace(/\&nbsp;/g,"");""==b&&(a=!0)}a?c(this).remove():c(this).before(o(c(this))).replaceWith("<br/><br/>");return!0}if(-1!=c.inArray(a,i.validTags)){var a=c.map(this.attributes,function(a){return a.name}),g=c(this);c.each(a,function(a,b){"href"!=b&&("src"!=b&&"class"!=b)&&g.removeAttr(b)});c(this).html(o(c(this)))}else b=c(this).children(),0<b.size()?c(this).after(o(c(this))):(a=c(this).text(),a=a.replace(/\n+/g,""),c(this).after(a)),c(this).remove()});return c(b).html()}
function A(){var b=[];c("img[alt=':)']:first").parent().parent().find("img").each(function(a,d){var g=c(d).attr("title"),h=c(d).attr("alt"),f=d.outerHTML;g&&h&&b.push({title:g,img:f,bbcode:h})});5<b.length&&(i.smileList=b)}function G(){for(var b={},a=[],c=0;c<i.smileList.length;c++){var g=i.smileList[c];g.img=g.img.replace(g.bbcode,"");b[g.bbcode]=g;a.push(g.bbcode)}a.sort(function(a,b){return a.length>b.length?-1:1});g=[];for(c=0;c<a.length;c++)g.push(b[a[c]]);i.smileList=g}function F(b,a,c){for(;b.match(a);)b=
b.replace(a,c);return b}function E(b){function a(){if(!c(this).is("span,font"))return!1;if(0==c(this).html().length||0<c(this).children().size()&&(c(this).children().filter(a).remove(),0==c(this).html().length&&"BODY"!=this.tagName))return!0}c(b).children().filter(a).remove()}var j,k,C,m,w;q("Init WysiBB");var h=c(this),s,x,r,l,p;j=this;k=i.bbmode;C=[];w=["wbbConvertation"];i.smileAutoDetect&&A();(function(){h.css("border","0").css("outline","none");h.after(n('<link rel="stylesheet" type="text/css" media="all" href="{themePrefix}/{themeName}/theme.css" />',
i));h.wrap('<div class="wysibb"></div>');var b=i.buttons.split(",");if(b&&0<b.length){c.extend(i.allButtons,i.extraButtons);delete i.extraButtons;q("Create toolbar. Active buttons: "+b.length);for(var a=h.before('<div class="wysibb-toolbar"></div>').prev(),d=0;d<b.length;d++){var g=c.trim(b[d].toLowerCase());if("|"==g)a.append('<div class="wysibb-toolbar-vert"></div>');else{var v=i.allButtons[g];if(v){v.buttonHTML=n(v.buttonHTML,i);var f=c(n('<div class="wysibb-toolbar-btn" title="{title}" unselectable="on">{buttonHTML}</div>',
v));a.append(f);f=new y(eval(v.command),f,v);C.push(f);w.push(g)}}}a.append('<div class="wysibb-toolbar-btn btnModeSwitch" title="\u041f\u043e\u043a\u0430\u0437\u0430\u0442\u044c BBcode" unselectable="on"><span class="ve-tlb-bbcode" unselectable="on"></span></div>');a.find(".btnModeSwitch").click(function(){k?(k=!1,c(l).html(u(h.val())),s.show(),h.hide().val(""),c(this).removeClass("on")):(k=!0,h.val(B(l)),s.hide(),h.show(),c(this).addClass("on"))})}if(i.smileList){b=h.after('<div class="wysibb-toolbar wysibb-bottom-toolbar"></div>').next();
for(d=0;d<i.smileList.length;d++)a=i.smileList[d],a.img=n(a.img,i),f=c(n('<div class="wysibb-toolbar-btn" title="{title}" unselectable="on">{img}</div>',a)),b.append(f),f=new y(new z,f,a);b.append('<div class="wysibb-powered" title="\u0420\u0435\u0434\u0430\u043a\u0442\u043e\u0440 BBcode" unselectable="on"><a href="http://www.wysibb.com" target="_blank">WysiBB</a></div>')}G();h.wrap('<div class="wysibb-text"></div>');!0!==i.onlyBBmode&&(d=h.width(),f=h.height(),q("iFrame width:"+d),h.parents(".wysibb").css("width",
d+"px"),h.css("width",d-12+"px").css("margin","0").css("font-size","14px").css("padding","0"),s=c(n('<iframe src="about:blank" class="wysibb-text-iframe" frameborder="0" style="margin:0;width:{width}px;height:{height}px;max-width:100%"></iframe>',{width:d,height:f})),s.bind("load",function(){x=s.get(0);r=x.contentWindow;p=x.contentWindow.document;l=x.contentWindow.document.body;var a=p.getElementsByTagName("head")[0];c(document.getElementsByTagName("head")[0]).find("link[rel='stylesheet']").each(function(b,
d){c(a).append(c(d).clone())});c(document.body).find("link[rel='stylesheet']").each(function(b,d){c(a).append(c(d).clone())});c(l).css("margin","0").css("padding","0").css("background","#ffffff").css("text-align","left").css("font-size","12px");if("contentEditable"in l&&!D){l.contentEditable=!0;try{p.execCommand("StyleWithCSS",!1,!1)}catch(b){}}else k=i.onlyBBmode=!0;""!=h.val()&&(c(l).html(u(h.val())),h.val(""));c(p).bind("keyup mouseup",t);c(l).bind("paste",function(){var a=c(this);setTimeout(function(){o(a)},
10)});!0===i.watchTxtArea&&(c(document).live("click",function(a){if(!k&&c(a.target).parents(".wysibb").size()==0&&h.data("prevVal")!=h.val()){q("txtArea has changed");m.overrideWithNode(u(h.val()),null,null,true,true);h.val("");h.data("prevVal","")}}),h.data("prevVal",h.val()));c(l).bind("keydown",function(a){if(a.which==13&&m.getNode().tagName!="LI"){a.preventDefault();l.focus();a=m.getNode();(a.tagName=="DIV"||a.tagName=="BODY")&&a.lastChild.nodeName.toLowerCase()!="br"&&c(a).append("<br/>");a=
r.document.createElement("BR");m.overrideWithNode(a,null)}})}),h.after(s),h.hide());k&&(c(x).hide(),c(j).show());h.bind("keyup mouseup",t)})();m=new function(){this.getNode=function(b){if(k)return j.focus(),j;var a=null,a=window.getSelection?this.getRange().commonAncestorContainer:this.getRange().parentElement();return a=!b&&3===a.nodeType?a.parentNode:a};this.getNodeByRange=function(b){var a=null,a=window.getSelection?b.commonAncestorContainer:b.parentElement();return a=3===a.nodeType?c(a).parent().get(0):
a};this.getText=function(){return k?this.getTextWithInfo().text:window.getSelection?this.getRange().toString():this.getRange().text};this.getHTML=function(){var b;if(r.getSelection){b=r.getSelection();var a;b.getRangeAt?a=b.getRangeAt(0):(a=p.createRange(),a.setStart(b.anchorNode,b.anchorOffset),a.setEnd(b.focusNode,b.focusOffset));b=a.cloneContents();a=document.createElement("div");a.appendChild(b);return a.innerHTML}return p.selection?(b=p.selection.createRange(),b.htmlText):""};this.getRange=function(){if(window.getSelection)return l.focus(),
r.getSelection().getRangeAt(0);var b=r.document.selection.createRange();if(b)return b};this.getTextWithInfo=function(){if("selectionStart"in j&&k){var b=j.selectionEnd-j.selectionStart;return{start:j.selectionStart,end:j.selectionEnd,length:b,text:j.value.substr(j.selectionStart,b)}}if(document.selection&&k){j.focus();var b=document.selection.createRange(),a=j.createTextRange(),c=a.duplicate();c.moveToBookmark(b.getBookmark());a.setEndPoint("EndToStart",c);if(null==b||null==a)return{start:j.value.length,
end:j.value.length,length:0,text:""};c=b.text.replace(/[\r\n]/g,".");a=j.value.replace(/[\r\n]/g,".").indexOf(c,a.text.length);return{start:a,end:a+c.length,length:c.length,text:b.text}}return{start:e.value.length,end:e.value.length,length:0,text:""}};this.setRange=function(b){if(k)if(window.getSelection)j.selectionStart=b,j.selectionEnd=b;else{var a=j.createTextRange();a.collapse(!0);a.move("character",b);a.select()}};this.overrideWithNode=function(b,a,d){a||(a=this.getRange());l.focus();var g=window.getSelection?
!0:!1,h=m.get();this.getNodeByRange(a);if("string"==typeof b&&("<"!=b.substr(0,1)||">"!=b.substr(b.length-1,1)))b=p.createTextNode(b);else if("string"==typeof b){var f=p.createElement("SPAN");f.innerHTML=b;b=c(f).children().unwrap().get(0)}b=c(b).get(0);if(d){a:{(f=a)||(f=m.getRange());for(f=m.getNodeByRange(f);f&&"BODY"!=f.tagName;){if(c(f).is(d)){d=f;break a}if(f)f=f.parentNode;else{d=null;break a}}d=null}d&&c(d).remove()}else g&&a.deleteContents();g?(a.insertNode(b),a.setStartAfter(b),a.setEndAfter(b),
h.removeAllRanges(),h.addRange(a)):(a.pasteHTML(b.outerHTML),a.collapse(),a.select());t();return b};this.lastRange=null;this.get=function(){return window.getSelection?r.getSelection():r.document.selection};this.saveRange=function(){this.lastRange=window.getSelection?this.getRange().cloneRange():this.getRange()};this.getSavedRange=function(){return this.lastRange};this.setSelection=function(b,a,c,g){var h=m.get();b||(b=this.getRange());window.getSelection?(c&&g?(b.setStart(a,c),b.setEnd(a,g)):b.selectNodeContents(a),
h.removeAllRanges(),h.addRange(b)):a&&(b.moveToElementText(a),0<=c&&0<=g&&(b.moveStart("character",c),b.moveEnd("character",g)),b.select())}};(function(){q("initFormSubmit");h.parents("form").bind("submit",function(){try{return h.val(B(l)),!0}catch(b){return s.after('<div style="color:red;font-siz:10px;padding:10px;">\u041e\u0448\u0438\u0431\u043a\u0430 \u043f\u0440\u0438 \u0444\u043e\u0440\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0438 bbcode.</div>"'),!1}})})()})};c.fn.skipWBB=function(){return c(this).attr("mustremoved",
"1")}})(jQuery);
(function(b){b.fn.wysibb=function(z,A){function m(f,m){return f.replace(/\{([\w\.]*)\}/g,function(f,y){var u=y.split("."),n=m[u.shift()];b.each(u,function(){n=n[this]});return null===n||void 0===n?"":n})}function p(b){f.debug&&"undefined"!=typeof console&&console.log(b)}var f;f={debug:!0,onlyBBmode:!1,bbmode:!1,watchTxtArea:!0,smileAutoDetect:!0,themeName:"default",bbset:"default",themePrefix:"http://www.wysibb.com/static/theme/",validTags:"a b i s u div img ul li br p q strike blockquote table tr td".split(" "),
buttons:"bold,italic,underline,strike,sup,sub,|,justifyleft,justifycenter,justifyright,|,link,img,|,bullist,numlist,quote,offtopic,code,spoiler,",allButtons:{bold:{title:"\u0416\u0438\u0440\u043d\u044b\u0439",buttonHTML:'<span class="ve-tlb-bold"></span>',command:'new NativeCommand("Bold")',bbName:"b",bbOpen:"[b]",bbClose:"[/b]",htmlToBB:{b:"[b]%$(this).html()%[/b]",strong:"[b]%$(this).html()%[/b]"},bbToHTML:{"[b](.*?)[/b]":"<b>$1</b>"}},italic:{title:"\u041a\u0443\u0440\u0441\u0438\u0432",buttonHTML:'<span class="ve-tlb-italic"></span>',
command:'new NativeCommand("Italic")',bbName:"i",bbOpen:"[i]",bbClose:"[/i]",htmlToBB:{i:"[i]%$(this).html()%[/i]",em:"[i]%$(this).html()%[/i]"},bbToHTML:{"[i](.*?)[/i]":"<i>$1</i>"}},underline:{title:"\u041f\u043e\u0434\u0447\u0435\u0440\u043a\u043d\u0443\u0442\u044b\u0439",buttonHTML:'<span class="ve-tlb-underline"></span>',command:'new NativeCommand("Underline")',bbName:"u",bbOpen:"[u]",bbClose:"[/u]",htmlToBB:{u:"[u]%$(this).html()%[/u]"},bbToHTML:{"[u](.*?)[/u]":"<u>$1</u>"}},strike:{title:"\u0417\u0430\u0447\u0435\u0440\u043a\u043d\u0443\u0442\u044b\u0439",
buttonHTML:'<span class="ve-tlb-strike"></span>',command:'new NativeCommand("StrikeThrough")',bbName:"s",bbOpen:"[s]",bbClose:"[/s]",htmlToBB:{strike:"[s]%$(this).html()%[/s]"},bbToHTML:{"[s](.*?)[/s]":"<s>$1</s>"}},link:{title:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u0441\u0441\u044b\u043b\u043a\u0443",buttonHTML:'<span class="ve-tlb-link"></span>',command:"new linkCommand()",bbName:"url",bbOpen:"[url={href}]{href}",skipSelectRange:!0,bbClose:"[/url]",htmlToBB:{a:'[url=%$(this).attr("href")%]%$(this).html()%[/url]'},
bbToHTML:{"[url=(.*?)](.*?)[/url]":'<a href="$1">$2</a>'}},img:{title:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435",buttonHTML:'<span class="ve-tlb-img"></span>',command:"new imgCommand()",bbName:"img",bbOpen:"[img]{src}",bbClose:"[/img]",skipSelectRange:!0,htmlToBB:{img:'[img]%$(this).attr("src")%[/img]'},bbToHTML:{"[img](.*?)[/img]":'<img src="$1" />'}},bullist:{title:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u0441\u043f\u0438\u0441\u043e\u043a",
buttonHTML:'<span class="ve-tlb-list"></span>',command:'new NativeCommand("InsertUnorderedList")',bbName:"list",bbOpen:"[list]\n[*]",bbClose:"\n[/list]",htmlToBB:{ul:"[list]%$(this).html()%[/list]",li:"[*]%$(this).html()%"},bbToHTML:{"[*](.*?)(?=[)":"<li>$1</li>","[list](.*?)[/list]":"<ul>$1</ul>"}},numlist:{title:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u043d\u0443\u043c\u0435\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0439 \u0441\u043f\u0438\u0441\u043e\u043a",buttonHTML:'<span class="ve-tlb-numlist"></span>',
command:'new NativeCommand("InsertOrderedList")',bbName:"list=1",bbOpen:"[list=1]\n[*]",bbClose:"\n[/list]",htmlToBB:{ol:"[list=1]%$(this).html()%[/list]",li:"[*]%$(this).html()%"},bbToHTML:{"[*](.*?)(?=[)":"<li>$1</li>","[list=1](.*?)[/list]":"<ol>$1</ol>"}},justifyleft:{title:"\u0422\u0435\u043a\u0441\u0442 \u043f\u043e \u043b\u0435\u0432\u043e\u043c\u0443 \u043a\u0440\u0430\u044e",buttonHTML:'<span class="ve-tlb-textleft"></span>',command:'new NativeCommand("justifyLeft")',bbName:"left",bbOpen:"[left]",
bbClose:"[/left]",htmlToBB:{ol:"[list=1]%$(this).html()%[/list]",li:"[*]%$(this).html()%"},bbToHTML:{"[*](.*?)(?=[)":"<li>$1</li>","[list=1](.*?)[/list]":"<ol>$1</ol>"}},justifycenter:{title:"\u0422\u0435\u043a\u0441\u0442 \u043f\u043e \u0446\u0435\u043d\u0442\u0440\u0443",buttonHTML:'<span class="ve-tlb-textcenter"></span>',command:'new NativeCommand("justifyCenter")',bbName:"center",bbOpen:"[center]",bbClose:"[/center]",htmlToBB:{ol:"[list=1]%$(this).html()%[/list]",li:"[*]%$(this).html()%"},bbToHTML:{"[*](.*?)(?=[)":"<li>$1</li>",
"[list=1](.*?)[/list]":"<ol>$1</ol>"}},justifyright:{title:"\u0422\u0435\u043a\u0441\u0442 \u043f\u043e \u043f\u0440\u0430\u0432\u043e\u043c\u0443 \u043a\u0440\u0430\u044e",buttonHTML:'<span class="ve-tlb-textright"></span>',command:'new NativeCommand("justifyRight")',bbName:"right",bbOpen:"[right]",bbClose:"[/right]",htmlToBB:{ol:"[list=1]%$(this).html()%[/list]",li:"[*]%$(this).html()%"},bbToHTML:{"[*](.*?)(?=[)":"<li>$1</li>","[list=1](.*?)[/list]":"<ol>$1</ol>"}},offtopic:{title:"\u041e\u0444\u0444\u0442\u043e\u043f",
buttonHTML:'<span class="ve-tlb-offtopic"></span>',command:'new CustomCommand("offtopic")',htmlOpen:'<font style="font-size:9px;color:gray;">',htmlClose:"</font>",bbName:"offtop",bbOpen:"[offtop]",bbClose:"[/offtop]",htmlToBB:{'font[style*="font-size:9px;color:gray;"]':"[offtop]%$(this).html()%[/offtop]"},bbToHTML:{"[offtop](.*?)[/offtop]":'<font style="font-size:9px;color:gray;">$1</font>'},rootNode:'font[style*="font-size:9px;color:gray;"]'},code:{title:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u043a\u043e\u0434",
buttonHTML:'<span class="ve-tlb-code"></span>',command:'new CustomCommand("code")',htmlOpen:'<div class="code"><div class="codetop">\u041a\u043e\u0434</div><div class="codemain">',htmlClose:"</div></div>",bbName:"code",bbOpen:"[code]",bbClose:"[/code]",htmlToBB:{"div.codetop":'[code]%$(this).skipWBB().next("div.codemain").skipWBB().html()%[/code]'},rootNode:"div.code",contentSelector:'$(rootNode).find("div.codemain").html()',removeFormatOnDeSelect:!0},spoiler:{title:"\u0421\u0432\u043e\u0440\u0430\u0447\u0438\u0432\u0430\u0435\u043c\u044b\u0439 \u0442\u0435\u043a\u0441\u0442",
buttonHTML:'<span class="ve-tlb-spoiler"></span>',command:'new CustomCommand("spoiler")',htmlOpen:'<div class="spoiler"><div class="hidetop">\u0421\u043f\u043e\u0439\u043b\u0435\u0440 (+/-)</div><div class="hidemain">',htmlClose:"</div></div>",bbName:"spoiler",bbOpen:"[spoiler]",bbClose:"[/spoiler]",htmlToBB:{"div.spoiler":'[spoiler]%$(this).children("div.hidetop").skipWBB().next("div.hidemain").html()%[/spoiler]'},rootNode:"div.spoiler",contentSelector:'$(rootNode).find("div.hidemain").html()',removeFormatOnDeSelect:!0},
sub:{title:"\u041f\u043e\u0434\u0441\u0442\u0440\u043e\u0447\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442",buttonHTML:'<span class="ve-tlb-sub"></span>',command:'new NativeCommand("subscript")',bbName:"sub",bbOpen:"[sub]",bbClose:"[/sub]",htmlToBB:{sub:"[sub]%$(this).html()%[/sub]"},bbToHTML:{"[sub](.*?)[/sub]":"<sub>$1</sub>"}},sup:{title:"\u041d\u0430\u0434\u0441\u0442\u0440\u043e\u0447\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442",buttonHTML:'<span class="ve-tlb-sup"></span>',command:'new NativeCommand("superscript")',
bbName:"sup",bbOpen:"[sup]",bbClose:"[/sup]",htmlToBB:{sup:"[sup]%$(this).html()%[/sup]"},bbToHTML:{"[sup](.*?)[/sup]":"<sup>$1</sup>"}},quote:{title:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u0446\u0438\u0442\u0430\u0442\u0443",buttonHTML:'<span class="ve-tlb-quote"></span>',command:"new quoteCommand()",bbName:"quote",bbOpen:"[quote]",bbClose:"[/quote]",htmlToBB:{"div.quote":"[quote]%$(this).html()%[/quote]"},bbToHTML:{"[quote](.*?)[/quote]":'<div class="quote">$1</div>'},insertHTML:'<div class="quote">{SELTEXT}</div>',
rootNode:"div.quote"},wbbConvertation:{htmlToBB:{td:"[td]%$(this).html()%[/td]",tr:"[tr]%$(this).html()%[/tr]",table:"[table]%$(this).html()%[/table]"},bbToHTML:{"[table](.*?)[/table]":"<table>$1</table>","[tr](.*?)[/tr]":"<tr>$1</tr>","[td](.*?)[/td]":"<td>$1</td>","\n":"<br/>"}}},smileList:[{title:"\u0423\u043b\u044b\u0431\u043a\u0430",img:'<img src="{themePrefix}{themeName}/img/smiles/sm1.png" class="sm">',bbcode:":)"},{title:"\u041e\u0433\u043e\u0440\u0447\u0435\u043d\u0438\u0435",img:'<img src="{themePrefix}{themeName}/img/smiles/sm8.png" class="sm">',
bbcode:":("},{title:"\u0421\u043c\u0435\u0445",img:'<img src="{themePrefix}{themeName}/img/smiles/sm2.png" class="sm">',bbcode:":D"},{title:"\u041f\u043e\u0434\u043c\u0438\u0433\u0438\u0432\u0430\u043d\u0438\u0435",img:'<img src="{themePrefix}{themeName}/img/smiles/sm3.png" class="sm">',bbcode:";)"},{title:"\u0421\u043f\u0430\u0441\u0438\u0431\u043e, \u043a\u043b\u0430\u0441\u0441",img:'<img src="{themePrefix}{themeName}/img/smiles/sm4.png" class="sm">',bbcode:":up:"},{title:"\u0420\u0443\u0433\u0430\u044e",
img:'<img src="{themePrefix}{themeName}/img/smiles/sm5.png" class="sm">',bbcode:":down:"},{title:"\u0428\u043e\u043a",img:'<img src="{themePrefix}{themeName}/img/smiles/sm6.png" class="sm">',bbcode:":shock:"},{title:"\u0417\u043b\u043e\u0439",img:'<img src="{themePrefix}{themeName}/img/smiles/sm7.png" class="sm">',bbcode:":angry:"},{title:"\u0422\u043e\u0448\u043d\u0438\u0442",img:'<img src="{themePrefix}{themeName}/img/smiles/sm9.png" class="sm">',bbcode:":sick:"}]};b.extend(f,z,A);f.themePrefix||
b("script").each(function(m,t){var p=b(t).get(0).src.match(/(.*)jquery\.wysibb(\.min)?\.js$/);null!==p&&(f.themePrefix=p[1])});/android.+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent||navigator.vendor||window.opera)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|e\-|e\/|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(di|rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|xda(\-|2|g)|yas\-|your|zeto|zte\-/i.test((navigator.userAgent||
navigator.vendor||window.opera).substr(0,4));-1!=navigator.userAgent.toLowerCase().indexOf("msie 6")&&navigator.userAgent.toLowerCase().indexOf("msie 7");navigator.userAgent.toLowerCase().indexOf("msie 7");return this.each(function(){function y(a,c,d){this.updateUI=function(){a.queryState(d)?b(c).addClass("on"):b(c).removeClass("on")};b(c).attr("unselectable","on");b(c).find("*").attr("unselectable","on");b(c).bind("mousedown",function(a){a.preventDefault&&a.preventDefault()});b(c).click(function(){a.execute(d);
t()})}function t(){b(C).each(function(a,c){c.updateUI()})}function z(){this.execute=function(a){if(k){i.focus();var a=a.bbcode,c=o.getTextWithInfo();a.bbOpen||(a.bbOpen="");a.bbClose||(a.bbClose="");!0===a.skipSelectRange&&(c.text="");var b=m(a.bbOpen+c.text+a.bbClose,null);i.value=i.value.substr(0,c.start)+b+i.value.substr(c.end,i.value.length-c.end);"url"!=a.bbName&&("img"!=a.bbName&&0==c.length)&&o.setRange(c.start+b.length-a.bbClose.length)}else l.focus(),o.overrideWithNode(m(a.img,f),null,null,
!1,!1)};this.queryState=function(){return!1}}function B(a){var c="",a=b(a).clone(),d;for(d in f.smileList){var h=f.smileList[d],g=h.bbcode,j=b(h&&h.img?h.img:"");a.find("img").each(function(){b(this).attr("src")==j.attr("src")&&b(this).replaceWith(g)})}for(d=0;d<w.length;d++){var h=f.allButtons[w[d]].htmlToBB,i;for(i in h){var l=h[i];a.find(i).each(function(a,c){var d=l,d=d.replace(/\%(.*?)\%/g,function(a){a=a.substr(1,a.length-2);a=a.replace("this","el");try{return eval(a)}catch(d){return b(c).html()}});
b(c).replaceWith("<span>"+d+"</span>")})}}a.find("*[mustremoved='1']").remove();a.contents().each(function(){if(3===this.nodeType){var a=b(this).text();c+=a}else if(b(this)[0].tagName){if("br"==b(this)[0].tagName.toLowerCase())return c+="\n",!0;c+=B(this)}});return c}function u(a){for(var c=0;c<f.smileList.length;c++){var d=f.smileList[c],h=d.bbcode;if(d&&d.img)var h=h.replace(/([^a-z0-9])/gi,"\\$1"),g=RegExp(h,"mg"),a=a.replace(g,d.img)}for(c=0;c<w.length;c++){d=f.allButtons[w[c]];h=d.bbToHTML;h||
(h={},h[d.bbOpen+"(.*?)"+d.bbClose]=d.htmlOpen+"$1"+d.htmlClose);for(var j in h)d=h[j],j=j.replace(/\*\]/g,"\\*]"),j=j.replace(/\[/g,"\\["),j=j.replace(/\]/g,"\\]"),j=j.replace(/\\\[\\\[/g,"["),j=j.replace(/\\\]\\\]/g,"]"),g=RegExp(j,"mi"),a=D(a,g,d)}j=b("<div>"+a+"</div>");j.find("ul > br,table > br, tr > br").each(function(a,c){b(c).remove()});return j.html()}function n(a){b(a).children().each(function(){var a=b(this)[0].tagName.toLowerCase();if("p"==a||"div"==a){a=!1;if(1>=b(this).children().size()){var d=
b(this).text().replace(/\s+/g,""),d=d.replace(/\&nbsp;/g,"");""==d&&(a=!0)}a?b(this).remove():b(this).before(n(b(this))).replaceWith("<br/><br/>");return!0}if(-1!=b.inArray(a,f.validTags)){var a=b.map(this.attributes,function(a){return a.name}),h=b(this);b.each(a,function(a,c){"href"!=c&&("src"!=c&&"class"!=c)&&h.removeAttr(c)});b(this).html(n(b(this)))}else d=b(this).children(),0<d.size()?b(this).after(n(b(this))):(a=b(this).text(),a=a.replace(/\n+/g,""),b(this).after(a)),b(this).remove()});return b(a).html()}
function A(){var a=[];b("img[alt=':)']:first").parent().parent().find("img").each(function(c,d){var h=b(d).attr("title"),f=b(d).attr("alt"),g=d.outerHTML;h&&f&&a.push({title:h,img:g,bbcode:f})});5<a.length&&(f.smileList=a)}function E(){for(var a={},c=[],b=0;b<f.smileList.length;b++){var h=f.smileList[b];h.img=h.img.replace(h.bbcode,"");a[h.bbcode]=h;c.push(h.bbcode)}c.sort(function(a,c){return a.length>c.length?-1:1});h=[];for(b=0;b<c.length;b++)h.push(a[c[b]]);f.smileList=h}function D(a,c,b){for(;a.match(c);)a=
a.replace(c,b);return a}var i,k,C,o,w;p("Init WysiBB");var g=b(this),r,x,q,l,s;i=this;k=f.bbmode;C=[];w=["wbbConvertation"];f.smileAutoDetect&&A();(function(){g.css("border","0").css("outline","none");g.after(m('<link rel="stylesheet" type="text/css" media="all" href="{themePrefix}/{themeName}/theme.css" />',f));g.wrap('<div class="wysibb"></div>');var a=f.buttons.split(",");if(a&&0<a.length){b.extend(f.allButtons,f.extraButtons);delete f.extraButtons;p("Create toolbar. Active buttons: "+a.length);
for(var c=g.before('<div class="wysibb-toolbar"></div>').prev(),d=0;d<a.length;d++){var h=b.trim(a[d].toLowerCase());if("|"==h)c.append('<div class="wysibb-toolbar-vert"></div>');else{var v=f.allButtons[h];if(v){v.buttonHTML=m(v.buttonHTML,f);var j=b(m('<div class="wysibb-toolbar-btn" title="{title}" unselectable="on">{buttonHTML}</div>',v));c.append(j);j=new y(eval(v.command),j,v);C.push(j);w.push(h)}}}c.append('<div class="wysibb-toolbar-btn btnModeSwitch" title="\u041f\u043e\u043a\u0430\u0437\u0430\u0442\u044c BBcode" unselectable="on"><span class="ve-tlb-bbcode" unselectable="on"></span></div>');
c.find(".btnModeSwitch").click(function(){k?(k=!1,b(l).html(u(g.val())),r.show(),g.hide().val(""),b(this).removeClass("on")):(k=!0,g.val(B(l)),r.hide(),g.show(),b(this).addClass("on"))})}if(f.smileList){a=g.after('<div class="wysibb-toolbar wysibb-bottom-toolbar"></div>').next();for(d=0;d<f.smileList.length;d++)c=f.smileList[d],c.img=m(c.img,f),j=b(m('<div class="wysibb-toolbar-btn" title="{title}" unselectable="on">{img}</div>',c)),a.append(j),j=new y(new z,j,c);a.append('<div class="wysibb-powered" title="\u0420\u0435\u0434\u0430\u043a\u0442\u043e\u0440 BBcode" unselectable="on"><a href="http://www.wysibb.com" target="_blank">WysiBB</a></div>')}E();
g.wrap('<div class="wysibb-text"></div>');!0!==f.onlyBBmode&&(d=g.width(),j=g.outerHeight(),p("iFrame width:"+d),g.parents(".wysibb").css("width",d+"px"),g.css("width",d-12+"px").css("margin","0").css("font-size","14px"),r=b(m('<iframe src="about:blank" class="wysibb-text-iframe" frameborder="0" style="margin:0;width:{width}px;height:{height}px;max-width:100%"></iframe>',{width:d,height:j})),r.bind("load",function(){x=r.get(0);q=x.contentWindow;s=x.contentWindow.document;l=x.contentWindow.document.body;
var a=x.contentWindow.document.head;b(document.head).find("link[rel='stylesheet']").each(function(c,d){b(a).append(b(d).clone())});b(document.body).find("link[rel='stylesheet']").each(function(c,d){b(a).append(b(d).clone())});b(l).css("margin","0").css("padding","0").css("background","#ffffff").css("text-align","left").css("font-size","12px");if("contentEditable"in l){l.contentEditable=!0;try{s.execCommand("StyleWithCSS",!1,!1)}catch(c){}}else k=f.onlyBBmode=!0;""!=g.val()&&(b(l).html(u(g.val())),
g.val(""));b(s).bind("keyup mouseup",t);b(l).bind("paste",function(){var a=b(this);setTimeout(function(){n(a)},10)});!0===f.watchTxtArea&&(b(document).live("click",function(a){if(!k&&b(a.target).parents(".wysibb").size()==0&&g.data("prevVal")!=g.val()){p("txtArea has changed");o.overrideWithNode(u(g.val()),null,null,true,true);g.val("");g.data("prevVal","")}}),g.data("prevVal",g.val()));b(l).bind("keydown",function(a){if(a.which==13&&o.getNode().tagName!="LI"){a.preventDefault();l.focus();a=q.document.createElement("BR");
o.overrideWithNode(a,null,null)}!b.browser.msie&&(!l.lastChild||l.lastChild.nodeName.toLowerCase()!="br")&&b(l).append("<br/>")})}),g.after(r),g.hide());k&&(b(x).hide(),b(i).show());g.bind("keyup mouseup",t)})();o=new function(){this.getNode=function(){if(k)return i.focus(),i;var a=null,a=window.getSelection?this.getRange().commonAncestorContainer:this.getRange().parentElement();return a=3===a.nodeType?b(a).parent().get(0):a};this.getNodeByRange=function(a){var c=null,c=window.getSelection?a.commonAncestorContainer:
a.parentElement();return c=3===c.nodeType?b(c).parent().get(0):c};this.getText=function(){return k?this.getTextWithInfo().text:window.getSelection?this.getRange().toString():this.getRange().text};this.getHTML=function(){var a;if(q.getSelection){a=q.getSelection();var c;a.getRangeAt?c=a.getRangeAt(0):(c=s.createRange(),c.setStart(a.anchorNode,a.anchorOffset),c.setEnd(a.focusNode,a.focusOffset));a=c.cloneContents();c=document.createElement("div");c.appendChild(a);return c.innerHTML}return s.selection?
(a=s.selection.createRange(),a.htmlText):""};this.getRange=function(){if(window.getSelection)return l.focus(),q.getSelection().getRangeAt(0);var a=q.document.selection.createRange();if(a)return a};this.getTextWithInfo=function(){if("selectionStart"in i&&k){var a=i.selectionEnd-i.selectionStart;return{start:i.selectionStart,end:i.selectionEnd,length:a,text:i.value.substr(i.selectionStart,a)}}if(document.selection&&k){i.focus();var a=document.selection.createRange(),c=i.createTextRange(),b=c.duplicate();
b.moveToBookmark(a.getBookmark());c.setEndPoint("EndToStart",b);if(null==a||null==c)return{start:i.value.length,end:i.value.length,length:0,text:""};b=a.text.replace(/[\r\n]/g,".");c=i.value.replace(/[\r\n]/g,".").indexOf(b,c.text.length);return{start:c,end:c+b.length,length:b.length,text:a.text}}return{start:e.value.length,end:e.value.length,length:0,text:""}};this.setRange=function(a){if(k)if(window.getSelection)i.selectionStart=a,i.selectionEnd=a;else{var c=i.createTextRange();c.collapse(!0);c.move("character",
a);c.select()}};this.overrideWithNode=function(a,c,d,h,f){c||(c=this.getRange());l.focus();var g=window.getSelection?!0:!1,i=o.get(),k=this.getNodeByRange(c);d&&b(d).remove();var m,d=a;"string"==typeof a?(d=s.createElement("SPAN"),a=b.trim(a),"<"==a.substr(0,1)&&a.substr(a.length-1,1)?(m=b(a),b(d).append(a)):b(d).html(a)):m=b(a);!0===f?"BODY"!=k.tagName?b(k).parent().is("span")?b(k).parent().after(d):b(k).after(d):b(k).append(d):(m&&m.is(k.tagName)?b(k).remove():g&&c.deleteContents(),g?(c.insertNode(d),
h?(c.setStart(d,0),c.setEnd(d,0)):(c.setStartAfter(d),c.setEndAfter(d)),i.removeAllRanges(),i.addRange(c)):(c.pasteHTML(d.outerHTML),c.collapse(),c.select()));t()};this.lastRange=null;this.get=function(){return window.getSelection?q.getSelection():q.document.selection};this.saveRange=function(){this.lastRange=window.getSelection?this.getRange().cloneRange():this.getRange()};this.getSavedRange=function(){return this.lastRange};this.setSelection=function(a,c,b,f){var g=o.get();a||(a=this.getRange());
window.getSelection?(a.setStart(c,b),a.setEnd(c,f),g.removeAllRanges(),g.addRange(a)):(a.moveToElementText(c),a.moveStart("character",b),a.moveEnd("character",f))}};(function(){p("initFormSubmit");g.parents("form").bind("submit",function(){try{return g.val(B(l)),!0}catch(a){return r.after('<div style="color:red;font-siz:10px;padding:10px;">\u041e\u0448\u0438\u0431\u043a\u0430 \u043f\u0440\u0438 \u0444\u043e\u0440\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0438 bbcode.</div>"'),!1}})})()})};
b.fn.skipWBB=function(){return b(this).attr("mustremoved","1")}})(jQuery);